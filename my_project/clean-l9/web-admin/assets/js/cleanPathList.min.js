"use strict";$(function(){$("#search").on("click",function(){var a="/admin/getPath?sn=",b=$("#sn").val();location.href=a+b;return false;});delAllSelect(snIds,"/admin/deletePath?type="+type+"&sn="+sn);
$("#dataList").on("click",'a[name="zip"]',function(){var a=this.href;$.getJSON(a,function(b){if(b.code=="N00000"){layer.msg(b.message+'&nbsp;&nbsp;&nbsp;&nbsp;<a href="'+b.data+'" target="_blank" title="下载">下载文件</a>',{icon:1,time:5000});
setTimeout(function(){window.open(b.data);},5000);}else{layer.msg(b.message,{icon:2,time:1000});}});return false;}).on("click",'a[name="mapBulid"]',function(){var a=this.href,b=$(this).attr("tabindex"),c=this.title;
$.ajax({type:"get",url:a,dataType:"json",success:function(m){if(m.infoType==20004){var q=m.data,s=q.width,o=q.height,l=q.resolution,f=q.x_min,e=q.y_min,r=q.posArray,k=r.length,g=$('input[name="selDel"]').length,n=$("#next"),i=$("#prev");
b=parseInt(b);if(b==1){i.hide();}else{i.show();}if(b==g){n.hide();}else{n.show();}i.attr({"data-index":b});n.attr({"data-index":b});$("#start").html((new Date(q.start*1000)).Format("yyyy-MM-dd hh:mm:ss"));
$("#end").html((new Date(q.end*1000)).Format("yyyy-MM-dd hh:mm:ss"));$("#sweep").html(q.sweep);$("#cleanTime").html(parseFloat(q.cleanTime/60).toFixed(2)+"min");
$("#isDown").html(q.isDown);$("#isError").html(q.isError);drawMap(q.map,s,o,q.lz4_len);var p=layer.open({type:1,area:[(s+350)+"px","auto"],maxmin:true,shade:0,title:c,content:$("#mapBox"),success:function(d,h){$("#range").on("change",function(){var t=1000-parseInt(this.value);
clearTimeout(timer);drawMap(q.map,s,o,q.lz4_len);setTimeout(function(){drawLine(r,o,l,f,e,k,t);},5);}).prop({value:980});},cancel:function(){r=[];}});drawLine(r,o,l,f,e,k,20);
}else{layer.msg(m.message,{icon:2,time:1000});}},error:function(d,f,e){layer.msg("网络错误!",{icon:2,time:1000});},});return false;});$("#prev,#next").on("click",function(c){var d=$(c.target),a=$('input[name="selDel"]').length,b=$(this).attr("data-index");
b=parseInt(b);if(d.is("#prev")){b=b-1;b=b>=1?b:1;}else{b=b+1;b=b<=a?b:a;}layer.closeAll();$('#dataList a[name="mapBulid"]').eq(b-1).trigger("click");return false;
});$("#zipList").on("click",function(){var b=this.href,d=$('input[name="selDel"]').length,a=$('input[name="selDel"]:checked'),c=[];if(a.length<=0){layer.msg("您还未选择要压缩的数据!",{icon:2,time:1000});
return false;}if(d==a.length){b+="&isAll=1";}else{a.each(function(){var e=$(this);c.push(e.attr("value"));});b+=c.toString();}layer.confirm("压缩可能要等待几分钟，是否开始？",function(e){$.ajax({type:"get",url:b,dataType:"json",success:function(f){if(f.code=="N00000"){layer.msg(f.message+'&nbsp;&nbsp;&nbsp;&nbsp;<a href="'+f.data+'" target="_blank" title="下载">下载文件</a>',{icon:1,time:5000});
setTimeout(function(){window.open(f.data);},5000);}else{layer.msg(f.message,{icon:2,time:1000});}},error:function(f,h,g){layer.msg("网络错误!",{icon:2,time:1000});
},});});return false;});});var Buffer=require("buffer").Buffer,LZ4=require("lz4"),uncompressed=new Buffer(1024*1024),uncompressedSize=0;var mapCanvas=$("#map")[0],mapCanvasCtx=mapCanvas.getContext("2d");
function drawMap(g,a,f,d){var c=new Buffer(g,"base64");uncompressedSize=LZ4.decodeBlock(c,uncompressed);if(d===c.byteLength){mapCanvas.width=a;mapCanvas.height=f;
mapCanvasCtx.clearRect(a,f,a,f);var k=mapCanvasCtx.getImageData(0,0,a,f);if(uncompressedSize>0){for(var b=uncompressedSize;b>=0;b--){k.data[4*b]=uncompressed[b];
k.data[4*b+1]=uncompressed[b];k.data[4*b+2]=uncompressed[b];k.data[4*b+3]=255;}}mapCanvasCtx.putImageData(k,0,0);var e=mapCanvasCtx.getImageData(0,0,a,f);
mapCanvasCtx.putImageData(imageDataVRevert(e,k),0,0);mapCanvasCtx.save();}}var timer=null;function drawLine(k,e,b,g,d,f,a){mapCanvasCtx.strokeStyle="#FF0000";
a=(a==""||a==undefined)?20:a;mapCanvasCtx.beginPath();for(var c=f;c>=0;c--){(function(h){timer=setTimeout(function(){var i=trangeXY(k[h][0],k[h][1],g,d,b,e);
if(h==0){mapCanvasCtx.moveTo(i[0],i[1]);}mapCanvasCtx.lineTo(i[0],i[1]);mapCanvasCtx.stroke();},a);})(c);}mapCanvasCtx.closePath();}function imageDataVRevert(f,e){for(var c=0,d=f.height;
c<d;c++){for(var b=0,a=f.width;b<a;b++){e.data[c*a*4+b*4+0]=f.data[(d-c)*a*4+b*4+0];e.data[c*a*4+b*4+1]=f.data[(d-c)*a*4+b*4+1];e.data[c*a*4+b*4+2]=f.data[(d-c)*a*4+b*4+2];
e.data[c*a*4+b*4+3]=f.data[(d-c)*a*4+b*4+3];}}return e;}function imageDataHRevert(d,c){for(var a=0,b=d.height;a<b;a++){for(j=0,w=d.width;j<w;j++){c.data[a*w*4+j*4+0]=d.data[a*w*4+(w-j)*4+0];
c.data[a*w*4+j*4+1]=d.data[a*w*4+(w-j)*4+1];c.data[a*w*4+j*4+2]=d.data[a*w*4+(w-j)*4+2];c.data[a*w*4+j*4+3]=d.data[a*w*4+(w-j)*4+3];}}return c;}function trangeXY(a,i,g,f,d,e){var c=(a/1000-g)/d,b=(i/1000-f)/d;
b=e-b;return[c,b];}Date.prototype.Format=function(a){var c={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};
if(/(y+)/.test(a)){a=a.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length));}for(var b in c){if(new RegExp("("+b+")").test(a)){a=a.replace(RegExp.$1,(RegExp.$1.length==1)?(c[b]):(("00"+c[b]).substr((""+c[b]).length)));
}}return a;};